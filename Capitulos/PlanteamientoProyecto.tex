\chapter{Planteamiento del Proyecto}
\label{cap:planteamiento}

\begin{resumen}
En este capítulo vamos a hablar de los objetivos principales del proyecto, así como de las decisiones tomadas en cuanto a diseño del motor y del editor.
\end{resumen}

\section{Objetivos principales del Proyecto}
Nuestra idea principal era el desarrollo de un motor de videojuegos, enfocado a los RPG 2D, acompañado de un editor que permitiese un desarrollo rápido y sin mucha complicación de juegos de este tipo, sobre todo para gente no programadora o sin experiencia en el desarrollo de videojuegos. El videojuego generado por el editor debería ser multiplataforma, y poderse ejecutar en Windows, Mac, Linux y Android. Por otra parte, el editor también sería multiplataforma, para las anteriormente mencionadas excepto Android, ya que no es la plataforma más preferible a la hora de poder ejecutar un editor\footnote{Los editores suelen tener elementos que son preferibles de ser utilizados mediante entrada de teclado y ratón. Si bien es cierto que Android permite la conexión de periféricos de entrada-salida, es una plataforma pensada para dispositivos móviles y táctiles.}. 

\medskip

El editor debería ser capaz de poder generar las cuatro versiones del juego distintas para cada plataforma, permitir al usuario elegir para qué plataforma generar el ejecutable, y volcar todo el contenido desarrollado a estos, asegurando que el comportamiento programado fuese el mismo que en el juego final, y que sea esta versión la que el usuario pueda empaquetar y distribuir, sin la necesidad de hacer nada más.

\smallskip

El editor también debe ser capaz de poder generar diversos proyectos (es decir, distintos juegos), y capaz de guardar el estado de un proyecto y poder recuperarlo cuando el usuario desee, sin que este haya podido perder ningún cambio que haya realizado. Y, finalmente, debe poder exportar proyectos, e importar otros que otros usuarios puedan haber generado en otras plataformas sin mayor dificultad.

\medskip

El motor, por su parte, aportará la mayor parte del \textit{gameplay}, para que el usuario solo tenga que desarrollar la parte de diseño (principalmente el diseño artístico y visual. Tendrá que tener soporte para periféricos de entrada-salida tradicionales (teclado y ratón), así como entrada táctil (para los dispositivos móviles). 

\section{Toma de decisiones}
\label{sec:decisiones}
La primera decisión a tomar fue la plataforma de desarrollo del Proyecto. El Proyecto se iba a desarrollar íntegramente en C++, ya que se quería aprovechar la potencia que ofrece con respecto a otros lenguajes, el soporte multiplataforma que tiene la familia C/C++ tanto en dispositivos de sobremesa como en móviles, y el uso de librerías más avanzadas que nos facilitarían a la hora de desarrollar el Proyecto.

\medskip

Debido a nuestra premisa de un desarrollo multiplataforma, se necesitaba usar un IDE (\textit{integrated development environment}, entorno de desarrollo integrado) que fuese compatible tanto con Windows, Mac, y Linux. La opción que en un principio se había valorado era la de utilizar \textit{Visual Studio}, una de las herramientas más populares para el desarrollo en C++; sin embargo, debido a que este IDE carece de versiones para Mac y Linux\footnote{Mac y Linux cuentan con \textit{Visual Studio Code}, que si bien sirve para poder compilar C/C++, es más complicado de configurar para proyectos más complejos como este.}, se optó por hacer el desarrollo del Proyecto en \textit{CLion}, un IDE con soporte para CMake, que facilitaría a la hora de agilizar el trabajo (la compilación utilizando CMake, en nuestra experiencia, es considerablemente más rápida que la compilación utilizando el compilador por defecto de \textit{Visual Studio}) y con la gestión de las dependencias externas.

\smallskip

Pese a que el aprender a usar CMake ocupó gran parte del inicio del desarrollo del Proyecto, las ventajas que han supuesto a la hora del manejo de las distintas dependencias externas frente a la alternativa que se había valorado\footnote{La alternativa era utilizar \textit{submódulos} en GitHub, pero eso suponía un elevado coste extra a la hora de clonar el proyecto (en lugar de clonar únicamente el código a una máquina, todas las librerías que se utilizasen tendrían que ser clonadas), actualizar las librerías, etc\ldots} han hecho que esta opción haya merecido la pena.

\medskip

Por otra parte, se tendría que utilizar otra herramienta para el desarrollo de la APK (\textit{Android Application Package}, paquete de aplicaciones Android, es decir, el \comillas{ejecutable} de Android), ya que esta se debe desarrollar utilizando Java, por lo que se decidió utilizar \textit{Android Studio}, la herramienta oficial de desarrollo para Android, que proporciona máquinas virtuales de dispositivos Android de distintas versiones y generaciones para poder probar la \textit{build}.

\smallskip

Dentro de \textit{Android Studio}, se tendría que añadir también el módulo de NDK (\textit{Native Development Kit}, kit de desarrollo nativo) que permite el desarrollo de aplicaciones para Android utilizando llamadas a C/C++ gracias a JNI (\textit{Java Native Interface}, interfaz nativa de Java), una FFI (\textit{foreign function interface}, interfaz de funciones foráneas, es decir, un mecanismo por el cual un lenguaje de programación puede llamar a funciones o rutinas programadas o compiladas en otro lenguaje de programación distinto) integrada en el SDK de Java que permite la comunicación con C/C++. Esto sería necesario para poder ejecutar el juego, pese a que la entrada de la aplicación estuviese en Java.

\medskip

El resto de decisiones son propias de cada una de las partes del Proyecto y vamos a detallarlas a continuación.

\subsection{Diseño del motor}
En cuanto al diseño del motor, las primeras decisiones giraban en torno al contenido \textit{gameplay} que se quería que este tuviese. La principal idea era poder diseñar juegos al estilo de las primeras generaciones de la saga \cite{pokemon} (es decir, un juego \textit{pokemonlike}). Finalmente, se determinó que el contenido fuese el siguiente:
\begin{itemize}
	\item Mapas, esenciales para el desarrollo de videojuegos. Estos estarían formados por dos elementos, un \textit{tilemap} (es decir, un conjunto de baldosas individuales unidas en un mismo archivo) y objetos.
	\item Personajes, con características personalizables y que pudiesen interactuar con la escena mediante el uso de eventos.
	\item Objetos, que son elementos que contienen atributos, como por ejemplo \textit{sprites}, eventos, sonidos, etc\ldots
\end{itemize}

El motor seguiría un patrón EC (entidad-componente), con las entidades agrupadas en distintas escenas.

\subsection{Diseño del editor}
Sobre el editor, la decisión más importante fue elegir qué librería se iba a utilizar para poder desarrollar toda la interfaz y la funcionalidad básica de este. Al ya haber optado por utilizar \texttt{SDL3} como base para el motor, se optó también como base para el editor, acompañada de \texttt{DearImGui} para el dibujado y manejo de los elementos de la interfaz.

\medskip

También, al ya haber optado por el uso de Lua como lenguaje de \textit{scripting} para el motor, se optó por el uso del mismo para la generación de \textit{scripts} del editor, acompañados por la librería \texttt{sol2}, que proporciona \textit{bindings} (código que permite el manejo de Lua desde C/C++ de una manera muy sencilla sin tener que lidiar con la a veces rebuscada sintaxis de la librería \texttt{lua} de C/C++) para facilitar el desarrollo.

\medskip

En cuanto a diseño, se decidió independizar el desarrollo del editor del motor para poder avanzar en el Proyecto de manera más rápida, por lo que el editor tiene sus propias clases encargadas del dibujado en pantalla, de la gestión de la entrada del usuario y del manejo del \textit{scripting} y ficheros.

\smallskip

Si bien es cierto que una de las técnicas comunes en el diseño de motor-editor es la de implementar el editor utilizando las propias funcionalidades del motor, ya que se evita tener que implementar dos veces las mismas funcionalidades (en cuanto al \textit{renderizado}, \textit{input} y \textit{scripting}), creemos que la opción escogida ha supuesto una menor carga de trabajo final en el Proyecto y ha permitido flujos de iteración en el desarrollo más ágiles.

\medskip

En cuanto a la estructura de código, se optó por utilizar un patrón típico en el desarrollo de \textit{software} no relacionado con videojuegos, basado en ventanas (o subventanas) anidadas otras ventanas, con el uso de ventanas modales que apareciesen sobre estas. Esta estructura permite una escalabilidad del proyecto mucho más sencilla en caso de futuras expansiones y una mayor modularidad con cada uno de los componentes que se quisiese integrar.

\medskip

Las ventanas tendrían comunicación unas con otras utilizando clases como \texttt{Project}, que almacenaría toda la información referente a cada uno de los proyectos que el usuario crease (por ejemplo, referencias a los \textit{tilesets}, \textit{sprites}, animaciones o mapas creados).

\smallskip

Se tendrían también diversos gestores, tanto de \textit{scripting}, como de elementos de entrada-salida de ficheros, como de preferencias del usuario y hasta un gestor de idiomas, que permite que el proyecto sea multilingüe\footnote{En un principio, únicamente en castellano y en inglés, pero debido al sistema implementado, es muy sencillo añadir nuevos idiomas en el caso que fuese necesario.} con una amplia escalabilidad en el caso de que se quisiesen añadir más idiomas.

\medskip

Para la persistencia de los ficheros de configuración del proyecto, se optó por utilizar archivos de Lua simulando el uso que otros formatos, como JSON o XML pudiesen tener, ya que permitía reusar Lua no solo como lenguaje de \textit{scripting} y no complicaba el tener que utilizar otra librería específica para ello. Estos archivos Lua difieren de los que el motor interpretará al final, ya que el editor necesita muchos más datos que para el motor son irrelevantes, por lo que se tendría que tener una parte de compilación o generación de la \textit{build} del juego que \comillas{tradujese} los archivos del editor a archivos del motor. Al igual que como ocurre en los motores más generales, se decidió que el editor no pudiese interpretar los archivos finales del juego\footnote{Esto es debido a que, en muchos casos, se quiere que el jugador final evite poder hacer modificaciones al juego si no dispone del código original de este, evitando posibles casos de piratería o distribución no autorizada.}

\bigskip

\figura{Bitmap/editorMapas}{width=\textwidth}{fig:mapeditor}{Editor de mapas de \textit{RPGBaker}.}

El editor, se diseñó teniendo en mente las características principales que se querían poder editar del motor, es decir, un editor de mapas que permitiese al usuario cargar sus propias \textit{tilesets}, decidir el tamaño de los mapas, añadir objetos de manera visual y establecer las colisiones, aprovechándose de la posibilidad de tener varias capas de dibujado, así como poder situar la posición de los mapas en el mundo (ver figura \ref{fig:mapeditor}); un editor de eventos, que permitirían flujos condicionales y la ejecución de animaciones o lanzamiento de otros eventos; un editor del personaje, que permitiese la personalización y configuración de elementos de este; y un editor de \textit{sprites} y animaciones, que permitiesen al usuario poder elegir un fichero de imagen, generar los \textit{sprites} decidiendo las coordenadas iniciales y el alto y ancho de la imagen, y con esos \textit{sprites} poder generar las animaciones, eligiendo el tiempo entre cada uno de los fotogramas y el orden de estos. Todos estos elementos tendrían que poder ser editados y eliminados una vez creados.

\medskip

En un principio, se contaba con la idea de que el editor tuviese un \textit{viewport} para que el usuario final pudiese ver en tiempo real el desarrollo que estaba haciendo, y poder ejecutar el juego desde el propio editor, al estilo de \textit{Unity}, pero debido a complicaciones con la API de \texttt{SDL3} decidimos descartarlo y permitir al usuario ejecutar su juego con una instancia del motor aparte.
